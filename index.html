<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recipe & Ingredient Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .toast {
            animation: slide-in-out 5s forwards;
        }
        @keyframes slide-in-out {
            0% { transform: translateY(100%); opacity: 0; }
            10% { transform: translateY(0); opacity: 1; }
            90% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0; }
        }
        /* Initially hide the main app and show the auth screen */
        #appContainer { display: none; }
        #authContainer { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Authentication Container -->
    <div id="authContainer" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h2 id="authTitle" class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Sign in to your account
                </h2>
            </div>
            <form id="authForm" class="mt-8 space-y-6">
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>

                <div>
                    <button id="authSubmitBtn" type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Sign in
                    </button>
                </div>
            </form>
            <div class="text-center">
                <button id="authToggleBtn" class="font-medium text-indigo-600 hover:text-indigo-500">
                    Don't have an account? Sign up
                </button>
            </div>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="appContainer" class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900">Recipe & Ingredient Tracker</h1>
            <div class="flex items-center justify-center gap-4 mt-2">
                 <p class="text-sm text-gray-600">Logged in as: <span id="userEmail" class="font-mono"></span></p>
                 <button id="logoutBtn" class="text-sm text-indigo-600 hover:text-indigo-500 underline">Logout</button>
            </div>
        </header>

        <main>
            <!-- Controls: Search, Add, Scan, and Shopping Helper -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div class="relative w-full sm:w-auto flex-grow">
                    <input type="text" id="searchInput" placeholder="Search by ingredient..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button id="shoppingHelperBtn" class="w-full sm:w-auto bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
                        Shopping Helper
                    </button>
                    <button id="scanRecipeBtn" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.776 48.776 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" /></svg>
                        Scan
                    </button>
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    <button id="addRecipeBtn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        Add
                    </button>
                </div>
            </div>

            <!-- Main Content: Recipe List and Details -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div id="recipeListContainer" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">My Recipes</h2>
                    <div id="recipeList" class="space-y-3">
                         <p class="text-gray-500">Please log in to see your recipes.</p>
                    </div>
                </div>
                <div id="recipeDetailsContainer" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                    <div id="recipeDetails" class="prose max-w-none">
                         <h2 class="text-2xl font-bold text-gray-500">Select a recipe to view details</h2>
                         <p class="text-gray-400">Your selected recipe's ingredients and instructions will appear here.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Recipe Modal -->
    <div id="recipeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 transform scale-95 relative">
            <div id="modalLoadingOverlay" class="absolute inset-0 bg-white bg-opacity-80 flex-col items-center justify-center rounded-lg hidden z-10">
                <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p id="loadingStatus" class="mt-4 text-lg font-semibold text-gray-700">Scanning Recipe...</p>
            </div>
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">Add a New Recipe</h2>
            <form id="recipeForm">
                <input type="hidden" id="recipeId">
                <div class="mb-4">
                    <label for="recipeName" class="block text-gray-700 font-semibold mb-2">Recipe Name</label>
                    <input type="text" id="recipeName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="recipeIngredients" class="block text-gray-700 font-semibold mb-2">Ingredients (one per line)</label>
                    <textarea id="recipeIngredients" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                </div>
                <div class="mb-6">
                    <label for="recipeInstructions" class="block text-gray-700 font-semibold mb-2">Instructions</label>
                    <textarea id="recipeInstructions" rows="6" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancelBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Save Recipe</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Shopping Helper Modal -->
    <div id="shoppingHelperModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-2xl p-8 transform scale-95">
            <div class="flex justify-between items-start">
                <h2 class="text-2xl font-bold mb-6">Shopping Helper</h2>
                <button id="closeShoppingHelperBtn" class="p-1 text-2xl leading-none">&times;</button>
            </div>
            <div id="shoppingListContainer" class="space-y-4 max-h-[60vh] overflow-y-auto">
                <!-- Shopping list will be generated here -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 transform scale-95">
            <h2 class="text-xl font-bold mb-4">Confirm Deletion</h2>
            <p id="confirmMessage" class="text-gray-600 mb-6">Are you sure you want to delete this recipe?</p>
            <div class="flex justify-end gap-4">
                <button type="button" id="confirmCancelBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button type="button" id="confirmOkBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-3 px-6 rounded-lg shadow-xl hidden toast">
        <p id="toastMessage"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- PASTE YOUR KEYS HERE ---
        const userFirebaseConfig = {
            apiKey: "AIzaSyCm4DF9s-TO4IXkzfjyEkyjqn1qcKcjiFo",
            authDomain: "recipe-app-38701.firebaseapp.com",
            projectId: "recipe-app-38701",
            storageBucket: "recipe-app-38701.appspot.com",
            messagingSenderId: "653745673289",
            appId: "1:653745673289:web:4abfe6261668501e60db98"
        };
        const userGeminiApiKey = "AIzaSyCWNKUWYzKCp3JV084ovB7NkEc6Zig0x2s";
        
        // --- End of Configuration ---

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
        const geminiApiKey = typeof __gemini_api_key !== 'undefined' ? __gemini_api_key : userGeminiApiKey;
        
        if (!firebaseConfig.apiKey || !geminiApiKey) {
            document.body.innerHTML = `<div class="p-8 text-center text-red-500"><h1>Configuration Error</h1><p>One or more API keys are missing. Please add your configuration to the index.html file.</p></div>`;
            throw new Error("Configuration missing. Halting execution.");
        }
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUserId = null;
        let unsubscribeRecipes = null;
        let recipesCache = [];
        let confirmCallback = null;
        let isLoginMode = true;

        // --- DOM ELEMENTS (Scoped to be safe) ---
        const ui = {
            auth: {
                container: document.getElementById('authContainer'),
                form: document.getElementById('authForm'),
                title: document.getElementById('authTitle'),
                submitBtn: document.getElementById('authSubmitBtn'),
                toggleBtn: document.getElementById('authToggleBtn'),
                emailInput: document.getElementById('email-address'),
                passwordInput: document.getElementById('password'),
            },
            app: {
                container: document.getElementById('appContainer'),
                logoutBtn: document.getElementById('logoutBtn'),
                refreshRecipesBtn: document.getElementById('refreshRecipesBtn'),
                userEmailDisplay: document.getElementById('userEmail'),
                recipeList: document.getElementById('recipeList'),
                recipeDetails: document.getElementById('recipeDetails'),
                addRecipeBtn: document.getElementById('addRecipeBtn'),
                scanRecipeBtn: document.getElementById('scanRecipeBtn'),
                shoppingHelperBtn: document.getElementById('shoppingHelperBtn'),
                imageUpload: document.getElementById('imageUpload'),
                searchInput: document.getElementById('searchInput'),
            },
            modals: {
                recipe: {
                    el: document.getElementById('recipeModal'),
                    form: document.getElementById('recipeForm'),
                    title: document.getElementById('modalTitle'),
                    id: document.getElementById('recipeId'),
                    name: document.getElementById('recipeName'),
                    ingredients: document.getElementById('recipeIngredients'),
                    instructions: document.getElementById('recipeInstructions'),
                    cancelBtn: document.getElementById('cancelBtn'),
                    loadingOverlay: document.getElementById('modalLoadingOverlay'),
                    loadingStatus: document.getElementById('loadingStatus')
                },
                shopping: {
                    el: document.getElementById('shoppingHelperModal'),
                    container: document.getElementById('shoppingListContainer'),
                    closeBtn: document.getElementById('closeShoppingHelperBtn')
                },
                confirm: {
                    el: document.getElementById('confirmModal'),
                    message: document.getElementById('confirmMessage'),
                    okBtn: document.getElementById('confirmOkBtn'),
                    cancelBtn: document.getElementById('confirmCancelBtn')
                }
            }
        };

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in.
                currentUserId = user.uid;
                ui.app.userEmailDisplay.textContent = user.email;
                ui.auth.container.style.display = 'none';
                ui.app.container.style.display = 'block';
                initializeAppEventListeners(); // Set up main app listeners
                fetchAndRenderRecipes();
            } else {
                // User is signed out.
                currentUserId = null;
                if(unsubscribeRecipes) unsubscribeRecipes();
                recipesCache = [];
                renderRecipeList([]);
                renderRecipeDetails(null);
                ui.auth.container.style.display = 'flex';
                ui.app.container.style.display = 'none';
            }
        });
        
        function handleAuthFormSubmit(e) {
            e.preventDefault();
            const email = ui.auth.emailInput.value;
            const password = ui.auth.passwordInput.value;

            if (isLoginMode) {
                signInWithEmailAndPassword(auth, email, password)
                    .catch(error => showToast(`Login failed: ${error.message}`, 'error'));
            } else {
                createUserWithEmailAndPassword(auth, email, password)
                    .catch(error => showToast(`Sign up failed: ${error.message}`, 'error'));
            }
        }
        
        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            ui.auth.title.textContent = isLoginMode ? 'Sign in to your account' : 'Create a new account';
            ui.auth.submitBtn.textContent = isLoginMode ? 'Sign in' : 'Sign up';
            ui.auth.toggleBtn.textContent = isLoginMode ? "Don't have an account? Sign up" : "Already have an account? Sign in";
        }

        // Setup auth listeners immediately
        ui.auth.form.addEventListener('submit', handleAuthFormSubmit);
        ui.auth.toggleBtn.addEventListener('click', toggleAuthMode);

        
        // --- RECIPE DATA LOGIC (FIRESTORE) ---
        async function fetchAndRenderRecipes() {
            if (!currentUserId) return;
            if (unsubscribeRecipes) unsubscribeRecipes();
            const recipesCol = collection(db, 'users', currentUserId, 'recipes');
            unsubscribeRecipes = onSnapshot(query(recipesCol), (snapshot) => {
                recipesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRecipeList(recipesCache);
                if (recipesCache.length === 0) renderRecipeDetails(null);
            }, error => {
                console.error("Error fetching recipes:", error);
                showToast("Failed to load recipes.", "error");
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!currentUserId) {
                showToast("User not authenticated. Cannot save.", "error");
                return;
            }
            const ingredients = ui.modals.recipe.ingredients.value.split('\n').map(i => i.trim()).filter(Boolean);
            if(ingredients.length === 0) {
                 return showToast("Please add ingredients.", "error");
            }

            setModalLoading(true, "Normalizing ingredients...");
            let normalizedIngredients = [];
            try {
                 const result = await normalizeIngredients(ingredients);
                 normalizedIngredients = result.normalizedIngredients;
            } catch (error) {
                console.error("Normalization failed:", error);
                showToast("Could not normalize ingredients, saving as is.", "warning");
                normalizedIngredients = ingredients.map(i => ({raw: i, core: i.toLowerCase().split(',')[0]})); // Basic fallback
            }
            setModalLoading(false);

            const recipeData = {
                name: ui.modals.recipe.name.value.trim(),
                ingredients: ingredients,
                normalizedIngredients: normalizedIngredients,
                instructions: ui.modals.recipe.instructions.value.trim(),
            };

            if (!recipeData.name || recipeData.ingredients.length === 0 || !recipeData.instructions) {
                return showToast("Please fill out all fields.", "error");
            }
            
            const recipeId = ui.modals.recipe.id.value;
            const recipesCol = collection(db, 'users', currentUserId, 'recipes');
            try {
                if (recipeId) {
                    await setDoc(doc(recipesCol, recipeId), recipeData);
                    showToast("Recipe updated successfully!");
                } else {
                    await addDoc(recipesCol, recipeData);
                    showToast("Recipe added successfully!");
                }
                closeRecipeModal();
            } catch (error) {
                console.error("Error saving recipe:", error);
                showToast("Failed to save recipe.", "error");
            }
        }

        function deleteRecipe(id) {
            openConfirmModal('Are you sure you want to delete this recipe?', async () => {
                try {
                    await deleteDoc(doc(db, 'users', currentUserId, 'recipes', id));
                    renderRecipeDetails(null);
                    showToast("Recipe deleted.");
                } catch (error) {
                    console.error("Error deleting recipe:", error);
                    showToast("Failed to delete recipe.", "error");
                }
            });
        }
        
        async function reNormalizeAllRecipes() {
             openConfirmModal('This will re-process all your recipes to improve ingredient grouping. This may take a moment. Continue?', async () => {
                showToast("Starting recipe refresh... Please wait.", "success");
                const recipesCol = collection(db, 'users', currentUserId, 'recipes');
                const batch = writeBatch(db);

                for (const recipe of recipesCache) {
                    if (recipe.ingredients && recipe.ingredients.length > 0) {
                        try {
                            const result = await normalizeIngredients(recipe.ingredients);
                            const recipeRef = doc(recipesCol, recipe.id);
                            batch.update(recipeRef, { normalizedIngredients: result.normalizedIngredients });
                        } catch (error) {
                            console.error(`Could not normalize recipe: ${recipe.name}`, error);
                        }
                    }
                }

                try {
                    await batch.commit();
                    showToast("All recipes have been refreshed!", "success");
                } catch (error) {
                    console.error("Error committing batch update:", error);
                    showToast("An error occurred during the refresh.", "error");
                }
            });
        }

        // --- RECIPE SCANNING & NORMALIZATION (GEMINI API) ---
        async function callGemini(prompt, inlineData = null, responseSchema = null) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            
            const parts = [{ text: prompt }];
            if (inlineData) {
                parts.push({ inlineData });
            }

            const payload = {
                contents: [{ role: "user", parts: parts }],
            };

            if (responseSchema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                };
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                console.error("API Error Body:", errorBody);
                throw new Error(`API request failed with status ${response.status}`);
            }
            
            const result = await response.json();
            const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!responseText) {
                 throw new Error("Invalid response structure from API.");
            }

            return responseSchema ? JSON.parse(responseText) : responseText;
        }

        async function getRecipeFromImage(base64ImageData, mimeType) {
            const prompt = "Analyze this image of a recipe. Extract the recipe name, instructions, and a list of ingredients. For the list of ingredients, combine preparation notes (like 'seeded and quartered' or 'toasted and cut into fingers') with the main ingredient they describe. Each item in the returned 'ingredients' array should be a complete string for a single ingredient line. For example, if the image shows '1 large red capsicum (pepper)' on one line and 'seeded and quartered' on the next, combine them into one string: '1 large red capsicum (pepper), seeded and quartered'. Return the data as a JSON object with 'name', 'ingredients' (an array of strings), and 'instructions' (a single string) fields.";
            const schema = {
                type: "OBJECT",
                properties: {
                    name: { type: "STRING" },
                    ingredients: { type: "ARRAY", items: { type: "STRING" } },
                    instructions: { type: "STRING" }
                },
                required: ["name", "ingredients", "instructions"]
            };
            return await callGemini(prompt, { mimeType: mimeType, data: base64ImageData }, schema);
        }

        async function normalizeIngredients(ingredients) {
            const prompt = `For each ingredient in the list, identify the base food item and return it as a normalized, singular string. It is critical to convert plural forms to singular (e.g., 'eggs' to 'egg', 'cloves' to 'clove'). Correct common misspellings (e.g., 'glove' to 'clove'). Remove non-essential descriptors like size (large, small), quantity, and simple preparation states (chopped, melted, softened), unless it creates a different product (e.g., 'buttermilk' vs 'butter'). The goal is to group similar items. For example, '1 large egg' and '2 eggs, beaten' should both have the core item 'egg'. '1 cup of melted butter' should be 'butter'. '2 red bell peppers' and '1 red bell pepper' should both become 'red bell pepper'. '3 garlic cloves' should become 'garlic clove'. Return a JSON object containing a list of objects, where each object has the original 'raw' ingredient and the processed 'core' ingredient. The list of ingredients is: ${JSON.stringify(ingredients)}`;
            const schema = {
                type: "OBJECT",
                properties: {
                    normalizedIngredients: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                raw: { type: "STRING" },
                                core: { type: "STRING" }
                            },
                            required: ["raw", "core"]
                        }
                    }
                },
                required: ["normalizedIngredients"]
            };
            return await callGemini(prompt, null, schema);
        }

        // --- UI RENDERING & INTERACTIONS ---
        function renderRecipeList(recipes) {
            ui.app.recipeList.innerHTML = '';
            if (recipes.length === 0) {
                ui.app.recipeList.innerHTML = '<p class="text-gray-500">No recipes found. Add one to get started!</p>';
                return;
            }
            recipes.forEach(recipe => {
                const item = document.createElement('div');
                item.className = 'p-4 border rounded-lg cursor-pointer hover:bg-gray-100 transition group';
                item.dataset.id = recipe.id;
                item.innerHTML = `<div class="flex justify-between items-center"><h3 class="font-semibold text-lg text-gray-800 group-hover:text-blue-600">${escapeHTML(recipe.name)}</h3><div class="flex items-center space-x-2 opacity-0 group-hover:opacity-100 transition-opacity"><button class="edit-btn p-1 text-gray-500 hover:text-blue-600" data-id="${recipe.id}"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg></button><button class="delete-btn p-1 text-gray-500 hover:text-red-600" data-id="${recipe.id}"><svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div></div>`;
                ui.app.recipeList.appendChild(item);
            });
        }
        
        function renderRecipeDetails(recipe) {
            if (!recipe) {
                ui.app.recipeDetails.innerHTML = `<h2 class="text-2xl font-bold text-gray-500">Select a recipe</h2><p class="text-gray-400">Recipe details will appear here.</p>`;
                return;
            }
            const ingredientsList = recipe.ingredients?.map(ing => `<li>${escapeHTML(ing)}</li>`).join('') || '<li>No ingredients listed.</li>';
            const instructionsHTML = recipe.instructions ? `<p>${escapeHTML(recipe.instructions).replace(/\n/g, '<br>')}</p>` : '<p>No instructions provided.</p>';
            ui.app.recipeDetails.innerHTML = `<h2 class="text-3xl font-bold mb-4">${escapeHTML(recipe.name)}</h2><h3 class="text-xl font-semibold mt-6 mb-2">Ingredients</h3><ul class="list-disc list-inside space-y-1">${ingredientsList}</ul><h3 class="text-xl font-semibold mt-6 mb-2">Instructions</h3><div class="prose-p:my-2">${instructionsHTML}</div>`;
        }
        
        function handleSearch() {
            const term = ui.app.searchInput.value.toLowerCase().trim();
            if (!term) {
                 renderRecipeList(recipesCache);
                 return;
            }
            const filtered = recipesCache.filter(r => 
                (r.ingredients && r.ingredients.some(i => i.toLowerCase().includes(term))) ||
                (r.normalizedIngredients && r.normalizedIngredients.some(ni => ni.core.toLowerCase().includes(term)))
            );
            renderRecipeList(filtered);
        }

        // --- MODAL CONTROLS ---
        function openRecipeModal(recipe = null) {
            ui.modals.recipe.form.reset();
            if (recipe) {
                ui.modals.recipe.title.textContent = 'Edit Recipe';
                ui.modals.recipe.id.value = recipe.id;
                ui.modals.recipe.name.value = recipe.name;
                ui.modals.recipe.ingredients.value = recipe.ingredients.join('\n');
                ui.modals.recipe.instructions.value = recipe.instructions;
            } else {
                ui.modals.recipe.title.textContent = 'Add New Recipe';
                ui.modals.recipe.id.value = '';
            }
            ui.modals.recipe.el.classList.remove('hidden');
            setTimeout(() => {
                ui.modals.recipe.el.classList.add('opacity-100');
                ui.modals.recipe.el.querySelector('.modal-content').classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function closeRecipeModal() {
            const recipeModal = ui.modals.recipe.el;
            recipeModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
            recipeModal.classList.remove('opacity-100');
            setTimeout(() => recipeModal.classList.add('hidden'), 250);
        }
        
        function setModalLoading(isLoading, statusText = "Scanning Recipe...") {
            ui.modals.recipe.loadingStatus.textContent = statusText;
            ui.modals.recipe.loadingOverlay.classList.toggle('hidden', !isLoading);
            ui.modals.recipe.loadingOverlay.classList.toggle('flex', isLoading);
        }

        function openConfirmModal(message, callback) {
            ui.modals.confirm.message.textContent = message;
            confirmCallback = callback;
            ui.modals.confirm.el.classList.remove('hidden');
            setTimeout(() => {
                ui.modals.confirm.el.classList.add('opacity-100');
                ui.modals.confirm.el.querySelector('.modal-content').classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function closeConfirmModal() {
            const confirmModal = ui.modals.confirm.el;
            confirmModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
            confirmModal.classList.remove('opacity-100');
            setTimeout(() => confirmModal.classList.add('hidden'), 250);
        }

        function openShoppingHelperModal() {
            ui.modals.shopping.el.classList.remove('hidden');
            setTimeout(() => {
                ui.modals.shopping.el.classList.add('opacity-100');
                ui.modals.shopping.el.querySelector('.modal-content').classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function closeShoppingHelperModal() {
            const shoppingModal = ui.modals.shopping.el;
            shoppingModal.querySelector('.modal-content').classList.replace('scale-100', 'scale-95');
            shoppingModal.classList.remove('opacity-100');
            setTimeout(() => shoppingModal.classList.add('hidden'), 250);
        }
        
        // --- SHOPPING HELPER LOGIC ---
        function generateShoppingList() {
            const ingredientMap = new Map();
            recipesCache.forEach(recipe => {
                if(recipe.normalizedIngredients && Array.isArray(recipe.normalizedIngredients)){
                    recipe.normalizedIngredients.forEach(ing => {
                        const core = ing.core.toLowerCase();
                        if (!ingredientMap.has(core)) {
                            ingredientMap.set(core, { count: 0, recipes: new Set() });
                        }
                        const entry = ingredientMap.get(core);
                        entry.count++;
                        entry.recipes.add(recipe.name);
                    });
                }
            });

            const sortedIngredients = Array.from(ingredientMap.entries()).sort((a, b) => b[1].count - a[1].count);
            
            ui.modals.shopping.container.innerHTML = '';
            if(sortedIngredients.length === 0){
                ui.modals.shopping.container.innerHTML = '<p class="text-gray-500">No recipes found or ingredients are not yet normalized. Please add or scan recipes first.</p>';
                return;
            }

            sortedIngredients.forEach(([core, data]) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-4 border rounded-lg bg-gray-50';
                itemEl.innerHTML = `
                    <h3 class="font-bold text-lg capitalize">${escapeHTML(core)}</h3>
                    <p class="text-sm text-gray-600">Used in <span class="font-semibold text-purple-700">${data.count}</span> recipe(s):</p>
                    <ul class="text-xs text-gray-500 list-disc list-inside mt-1">
                        ${[...data.recipes].map(name => `<li>${escapeHTML(name)}</li>`).join('')}
                    </ul>
                `;
                ui.modals.shopping.container.appendChild(itemEl);
            });
        }


        // --- HELPERS ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast'), msg = document.getElementById('toastMessage');
            msg.textContent = message;
            toast.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl toast';
            toast.classList.add(type === 'error' ? 'bg-red-600' : 'bg-gray-900');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4900);
        }
        
        function escapeHTML(str) {
            const p = document.createElement('p');
            p.textContent = str;
            return p.innerHTML;
        }

        // --- EVENT LISTENERS ---
        function initializeAppEventListeners() {
            // This function is called only AFTER a user is logged in.
            // It's safe to add listeners to the main app elements here.
            ui.app.logoutBtn.addEventListener('click', () => signOut(auth));
            ui.app.refreshRecipesBtn.addEventListener('click', reNormalizeAllRecipes);
            ui.app.addRecipeBtn.addEventListener('click', () => openRecipeModal());
            ui.modals.recipe.cancelBtn.addEventListener('click', closeRecipeModal);
            ui.modals.recipe.el.addEventListener('click', e => e.target === ui.modals.recipe.el && closeRecipeModal());
            ui.modals.recipe.form.addEventListener('submit', handleFormSubmit);
            
            ui.modals.confirm.cancelBtn.addEventListener('click', closeConfirmModal);
            ui.modals.confirm.el.addEventListener('click', e => e.target === ui.modals.confirm.el && closeConfirmModal());
            ui.modals.confirm.okBtn.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                closeConfirmModal();
            });

            ui.app.shoppingHelperBtn.addEventListener('click', () => {
                 generateShoppingList();
                 openShoppingHelperModal();
            });
            ui.modals.shopping.closeBtn.addEventListener('click', closeShoppingHelperModal);
            ui.modals.shopping.el.addEventListener('click', e => e.target === ui.modals.shopping.el && closeShoppingHelperModal());


            ui.app.scanRecipeBtn.addEventListener('click', () => ui.app.imageUpload.click());
            ui.app.imageUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                e.target.value = ''; // Reset file input
                if (!file) return;

                openRecipeModal();
                setModalLoading(true, "Scanning recipe...");
                
                const reader = new FileReader();
                reader.onloadend = async () => {
                    const base64ImageData = reader.result.split(',')[1];
                    try {
                        const rawRecipeData = await getRecipeFromImage(base64ImageData, file.type);
                        ui.modals.recipe.name.value = rawRecipeData.name || '';
                        ui.modals.recipe.instructions.value = rawRecipeData.instructions || '';
                        ui.modals.recipe.ingredients.value = (rawRecipeData.ingredients || []).join('\n');
                        showToast("Recipe scanned successfully! Please review.", "success");
                    } catch (error) {
                        console.error("Failed to get recipe from image:", error);
                        showToast("Could not read recipe from image.", "error");
                        closeRecipeModal();
                    } finally {
                        setModalLoading(false);
                    }
                };
                reader.readAsDataURL(file);
            });

            ui.app.searchInput.addEventListener('input', handleSearch);

            ui.app.recipeList.addEventListener('click', (e) => {
                const recipeItem = e.target.closest('[data-id]');
                if (!recipeItem) return;
                const recipeId = recipeItem.dataset.id;
                const recipe = recipesCache.find(r => r.id === recipeId);
                if (!recipe) return;

                if (e.target.closest('.edit-btn')) {
                    openRecipeModal(recipe);
                } else if (e.target.closest('.delete-btn')) {
                    deleteRecipe(recipeId);
                } else {
                    document.querySelectorAll('#recipeList [data-id]').forEach(el => el.classList.remove('bg-blue-100'));
                    recipeItem.classList.add('bg-blue-100');
                    renderRecipeDetails(recipe);
                }
            });
        }
    </script>
</body>
</html>
